#include "libraries.def"

#ifndef HasPosixThreads
#error "Posix threads are required"
#endif

SYS_LIBRARIES = MathLibrary ThreadsLibraries
DEPLIBS = $(DEPXLIB) $(DEPEXTENSIONLIB) $(DEPXRANDRLIB) $(DEPXRENDERLIB) \
  $(DEPXFIXESLIB) $(DEPXILIB) $(DEPXKBFILELIB)

LOCAL_LIBRARIES = $(XLIB) $(EXTENSIONLIB) $(XCBLIB) $(XCB) $(XCB_SHM)      \
  $(XRANDRLIB) $(PIXMAN) $(XRENDERLIB) $(XILIB) $(XKBFILELIB) $(XFIXESLIB) \
  $(XCB_DRI3) $(XCB_SHAPE) $(WAYLAND_SERVER)

INCLUDES := $(DRMINCLUDES) $(PIXMANINCLUDES)

SRCS = 12to11.c run.c alloc.c fns.c output.c compositor.c       \
  surface.c region.c shm.c atoms.c subcompositor.c positioner.c \
  xdg_wm.c xdg_surface.c xdg_toplevel.c frame_clock.c xerror.c  \
  ewmh.c timer.c subsurface.c seat.c data_device.c xdg_popup.c  \
  dmabuf.c buffer.c select.c xdata.c xsettings.c dnd.c          \
  icon_surface.c primary_selection.c renderer.c                 \
  picture_renderer.c explicit_synchronization.c transform.c     \
  wp_viewporter.c decoration.c text_input.c

OBJS = 12to11.o run.o alloc.o fns.o output.o compositor.o       \
  surface.o region.o shm.o atoms.o subcompositor.o positioner.o \
  xdg_wm.o xdg_surface.o xdg_toplevel.o frame_clock.o xerror.o  \
  ewmh.o timer.o subsurface.o seat.o data_device.o xdg_popup.o  \
  dmabuf.o buffer.o select.o xdata.o xsettings.o dnd.o          \
  icon_surface.o primary_selection.o renderer.o                 \
  picture_renderer.o explicit_synchronization.o transform.o     \
  wp_viewporter.o decoration.o text_input.o

GENHEADERS = transfer_atoms.h

#ifdef HaveEglSupport

       EGL_SRCS   = egl.c
       EGL_OBJS   = egl.o
LOCAL_LIBRARIES ::= $(LOCAL_LIBRARIES) $(EGL) $(GLES)
           SRCS ::= $(SRCS) $(EGL_SRCS)
           OBJS ::= $(OBJS) $(EGL_OBJS)
        DEFINES ::= $(DEFINES) -DHaveEglSupport

shaders.h: shaders.txt shaders.awk
	awk -f shaders.awk shaders.txt > $@

depend:: shaders.h

$(EGL_OBJS): shaders.h

cleandir::
	$(RM) shaders.h

#endif

OPTIMIZE = -O0
ANALYZE  = -fanalyzer

CDEBUGFLAGS := -fno-common -Wall -Warith-conversion -Wdate-time \
  -Wdisabled-optimization -Wdouble-promotion -Wduplicated-cond  \
  -Wextra -Wformat-signedness -Winit-self -Winvalid-pch         \
  -Wlogical-op -Wmissing-declarations -Wmissing-include-dirs    \
  -Wmissing-prototypes -Wnested-externs -Wnull-dereference      \
  -Wold-style-definition -Wopenmp-simd -Wpacked -Wpointer-arith \
  -Wstrict-prototypes -Wsuggest-attribute=format                \
  -Wsuggest-attribute=noreturn -Wsuggest-final-methods          \
  -Wsuggest-final-types -Wuninitialized -Wunknown-pragmas       \
  -Wunused-macros -Wvariadic-macros                             \
  -Wvector-operation-performance -Wwrite-strings                \
  -Warray-bounds=2 -Wattribute-alias=2 -Wformat=2               \
  -Wformat-truncation=2 -Wimplicit-fallthrough=5                \
  -Wshift-overflow=2 -Wuse-after-free=3 -Wvla-larger-than=4031  \
  -Wredundant-decls -Wno-missing-field-initializers             \
  -Wno-override-init -Wno-sign-compare -Wno-type-limits         \
  -Wno-unused-parameter -Wno-format-nonliteral -g3 $(OPTIMIZE)  \
  $(ANALYZE)

short_types.txt: media_types.txt
XCOMM	Remove all data types starting with application/vnd.
XCOMM	no program really uses them in clipboard data, and they
XCOMM	waste a lot of space on disk.
	sed '/application\/vnd/d' media_types.txt > $@

transfer_atoms.h: short_types.txt mime0.awk mime1.awk mime2.awk mime3.awk \
		  mime4.awk
	awk -f mime0.awk short_types.txt >  $@
	awk -f mime1.awk short_types.txt >> $@
	awk -f mime2.awk short_types.txt >> $@
	awk -f mime3.awk short_types.txt >> $@
	awk -f mime4.awk short_types.txt >> $@

/* Now, define generated files.  */

#define ScannerTarget(name)                                   @@\
name.h: name.xml                                              @@\
	$(WAYLAND_SCANNER) server-header $< $@                @@\
                                                              @@\
name.c: name.xml name.h                                       @@\
	$(WAYLAND_SCANNER) private-code $< $@                 @@\
                                                              @@\
GENHEADERS := $(GENHEADERS) name.h                            @@\
      OBJS := $(OBJS) name.o                                  @@\
      SRCS := $(SRCS) name.c                                  @@\
   GENSRCS := $(GENSRCS) name.c                               @@\

ScannerTarget(linux-dmabuf-unstable-v1)
ScannerTarget(xdg-shell)
ScannerTarget(primary-selection-unstable-v1)
ScannerTarget(linux-explicit-synchronization-unstable-v1)
ScannerTarget(viewporter)
ScannerTarget(xdg-decoration-unstable-v1)
ScannerTarget(text-input-unstable-v3)

/* Make OBJS depend on scanner headers, and depend on both them and SRCS.  */
$(OBJS): $(GENHEADERS)

/* depend somehow does not depend on SRCS, even though some of OBJS
   are generated.  */
depend:: $(GENHEADERS) $(SRCS)

cleandir::
	$(RM) $(GENHEADERS) $(GENSRCS) transfer_atoms.h short_types.txt \
	      12to11.tar.gz

/* Undefine _BSD_SOURCE and _SVID_SOURCE, since both are deprecated
   and are also superseeded by _GNU_SOURCE.  */

EXTRA_DEFINES := -D_GNU_SOURCE -U_BSD_SOURCE -U_SVID_SOURCE

ComplexProgramTarget(12to11)

.PHONY: dist
dist: 12to11.tar.gz

DIST_FILES = Imakefile $(SRCS) media_types.txt shaders.txt *.awk *.xml \
  12to11.man README libraries.def *.h

/* Include files generated by wayland-scanner, so the target does not
   need to have it installed.  */

12to11.tar.gz: $(DIST_FILES)
	rm -rf 12to11.tar.gz
	tar -cvf 12to11.tar $(DIST_FILES)
	gzip 12to11.tar
	$(RM) 12to11.tar
